name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Inject secrets into wrangler config
        run: |
          node -e "
            const fs = require('fs');
            // Strip trailing commas to convert JSONC to valid JSON
            const jsonc = fs.readFileSync('wrangler.jsonc', 'utf8');
            const json = jsonc.replace(/,(\s*[}\]])/g, '\$1');
            const config = JSON.parse(json);
            config.vars = {
              ...config.vars,
              AUTH_SECRET: process.env.AUTH_SECRET,
              ENGINE_API_KEY: process.env.ENGINE_API_KEY,
              GOOGLE_CLIENT_ID: process.env.GOOGLE_CLIENT_ID || '',
              GOOGLE_CLIENT_SECRET: process.env.GOOGLE_CLIENT_SECRET || ''
            };
            fs.writeFileSync('wrangler.jsonc', JSON.stringify(config, null, 2));
          "
        env:
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          ENGINE_API_KEY: ${{ secrets.ENGINE_API_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

      - name: Build for Cloudflare
        run: npx opennextjs-cloudflare build

      - name: Deploy to Cloudflare Workers
        run: npx opennextjs-cloudflare deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
